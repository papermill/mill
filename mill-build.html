<!DOCTYPE html>

<html>
<head>
  <title>mill-build.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="alias.html">
                alias.js
              </a>
            
              
              <a class="source" href="mill-build.html">
                mill-build.js
              </a>
            
              
              <a class="source" href="output.html">
                output.js
              </a>
            
              
              <a class="source" href="readProjectConfig.html">
                readProjectConfig.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
              
              <a class="source" href="mill-cli.html">
                mill-cli.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>mill-build.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><em>A module to build output from papermill project config</em></p>
<h1>Setup</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> fs = require(<span class="string">'fs-extra'</span>), <span class="comment">// uses 'graceful-fs' if available</span>
    path = require(<span class="string">'path'</span>),
    temp = require(<span class="string">'temp'</span>),
    async = require(<span class="string">'async'</span>),
    f = require(<span class="string">'underscore'</span>),
    pandoc = require(<span class="string">'pandoc-api'</span>);
    mill = require(<span class="string">'../../mill-cli'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1>Module</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>module.exports = <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">(project, callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Here lies just the workflow connecting the worker functions. 
Each functions <code>callback</code> values is the first argument of the next function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  async.waterfall(
    
    [
      <span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(callback)</span> {</span>
        inflateConfig(project, callback)
      },
      deriveBuildJobs,
      render
    ],
    
    callback
    
  );
  
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h1>Worker functions</h1>
<h2>inflateConfig</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">inflateConfig</span><span class="params">(config, callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <ul>
<li>apply defaults where nothing is given</li>
<li>read all lazy-configurable properties (input, output)</li>
<li>see if it is string, array or object</li>
<li>rewrite lazy values to full values</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Handle errors - TODO: spec validationâ€¦</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (!config) {
    callback(<span class="keyword">new</span> Error(<span class="string">"No config given, can't inflate!"</span>));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <ul>
<li><code>project</code> config just with &quot;known&quot; properties</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> project = f.pick(config, mill.config.get(<span class="string">'papermill:known_props'</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3><code>input</code> -- NOT optional for now</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  [<span class="string">'input'</span>].forEach(<span class="function"><span class="keyword">function</span> <span class="params">(prop)</span> {</span>
    
    <span class="keyword">if</span> (<span class="keyword">typeof</span> config[prop] === <span class="string">'undefined'</span>) {
      callback(<span class="string">"No config.input!"</span>);
    }
    
    <span class="keyword">var</span> item = config[prop];</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <ul>
<li>is it a string?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">typeof</span> item === <span class="string">'string'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>use it as <code>path</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      config[prop] = [{ <span class="string">'path'</span>: item }];
      <span class="keyword">return</span> <span class="literal">null</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <ul>
<li>is object (or array)?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">typeof</span> item === <span class="string">'object'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <ul>
<li>is really array?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (Array.isArray(item)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>nothing to do, TODO: recursion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> <span class="literal">null</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <ul>
<li>is really an object?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <ul>
<li>is there a non-empty list in it?
(Configure list property name to &#39;list&#39;)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> lst = <span class="string">'list'</span>;
        <span class="keyword">if</span> (item[lst] &amp;&amp; item[lst].length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <ul>
<li>prepare result</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">var</span> res = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <ul>
<li>save the base config, minus the <code>list</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          base = f.extend({}, f.omit(item, lst));</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <ul>
<li>loop over the list TODO: recursion</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          item.list.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(li)</span> {</span>
            
            <span class="keyword">var</span> i;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <ul>
<li>if there is a string inside, read as <code>path</code> to new obj</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> li === <span class="string">'string'</span>) {
              i = { <span class="string">'path'</span>: li };
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>extend with <code>base</code> (without <code>.path</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            i = f.extend({}, f.omit(base, <span class="string">'path'</span>), i);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <ul>
<li>set path by joining those from <code>base</code> and <code>i</code>, if they exist</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            i.path = path.join(base.path || <span class="string">''</span>, i.path || <span class="string">''</span>);
            
            res.push(i);
            
          });</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <ul>
<li>link the result</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          config[prop] = res;
          
        }
        <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <ul>
<li>just put it into array</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          config[prop] = [item];
        }
        
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <ul>
<li>extend with project config</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    config[prop].forEach(<span class="function"><span class="keyword">function</span> <span class="params">(obj, i)</span> {</span>
       config[prop][i] = f.extend({}, project, obj);
    });

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h3><code>output</code> (optional)</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  [<span class="string">'output'</span>].forEach(<span class="function"><span class="keyword">function</span> <span class="params">(prop)</span> {</span>
    
    <span class="keyword">var</span> defaultTargets = mill.config.get(<span class="string">'papermill:targets'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <ul>
<li>is there anything?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (config[prop] === <span class="literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>if not, load default config (string)!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      config[prop] = mill.config.get(<span class="string">'papermill:output_dir'</span>);
      
    }

    <span class="keyword">var</span> item = config[prop];</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <ul>
<li>is it a string?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">typeof</span> item === <span class="string">'string'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <ul>
<li>use it as <code>project.output_dir</code>!</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      config.output_dir = item;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <ul>
<li>item has no sub-folder</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      item = { <span class="string">'path'</span>: <span class="string">''</span> };</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <ul>
<li>apply default targets</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      defaultTargets.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(target)</span> {</span>
        item[target] = <span class="literal">true</span>;
      });
      
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <ul>
<li>is object/array?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">typeof</span> item === <span class="string">'object'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <ul>
<li>is array?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (Array.isArray(item)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>nothing to do!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <ul>
<li>is object?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <ul>
<li>make a new <code>list</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> list = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>try to read <code>path</code> to <code>output_dir</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (item.path &amp;&amp; <span class="keyword">typeof</span> item.path === <span class="string">'string'</span>) {
          config.output_dir = item.path;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <ul>
<li>read <code>base</code> config, minus <code>defaultTargets</code> and <code>path</code>
(for usage further down the tree)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      
        <span class="keyword">var</span> base = f.extend({}, f.omit(item, <span class="string">'path'</span>, defaultTargets));</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <ul>
<li>loop <em>each</em> default target</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        defaultTargets.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(target)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <ul>
<li>make empty <code>res</code>ult</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">var</span> res = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <ul>
<li>is there something?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (item[target] !== <span class="literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <ul>
<li>is it a boolean (true/false)?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> item[target] === <span class="string">'boolean'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <ul>
<li>is it <code>true</code>?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="keyword">if</span> (item[target] === <span class="literal">true</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <ul>
<li>use it, extended with the <code>base</code> settings</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                res = f.extend({}, base, { <span class="string">'target'</span>: target });
              }
              <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <ul>
<li>it is <code>false</code>, abort!</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> <span class="literal">null</span>;
              }
            
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <ul>
<li>is it an object (and not an array)?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> item[target] === <span class="string">'object'</span> &amp;&amp; !Array.isArray(item[target])) {</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <ul>
<li>try reading <code>output_dir</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="keyword">if</span> (item.path) {
                config.output_dir = item.path;
              }
              
            }
            
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <ul>
<li>extend <code>res</code> with <code>base</code> and <code>target</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          res = f.extend({}, base, item[target], { <span class="string">'target'</span>: target });</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <ul>
<li>add <code>obj</code> to <code>list</code> (if target was disabled we have already aborted)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          list.push(res);
        
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>if there is no <code>output_dir</code> found in config, apply default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!config.output_dir) {
          config.output_dir = mill.config.get(<span class="string">'papermill:output_dir'</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <ul>
<li>add new <code>list</code> to <code>config</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        config[prop] = list;
        
      }
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <ul>
<li><code>callback</code> with the inflated config</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  callback(<span class="literal">null</span>, config)

}</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h2>deriveBuildJobs</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">deriveBuildJobs</span><span class="params">(config, callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <ul>
<li>multiply inputs with outputs</li>
<li><p>TODO: ??? read metadata from input.output?</p>
</li>
<li><p>make empty result</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  config.jobs = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <ul>
<li><em>For each</em> item in <code>input</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  config.input.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(item)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <ul>
<li><em>For each</em> target in <code>output</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    config.output.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(target)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <ul>
<li>make job by combinig config in order</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> job = f.extend(
        {},
        f.omit(target, <span class="string">'path'</span>),
        f.omit(item, <span class="string">'path'</span>)
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <ul>
<li>handle <code>paths</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      job.input = item.path;
      job.output = target.path || <span class="string">''</span>; <span class="comment">// can be empty if no sub-dir</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <ul>
<li>load default pandoc config</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      job = f.extend(
        {},
        mill.config.get(<span class="string">'papermill:pandoc'</span>),
        job
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <ul>
<li>load default config for targets &#39;print&#39; and &#39;web&#39;</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      mill.config.get(<span class="string">'papermill:targets'</span>).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(target)</span> {</span>
        
        <span class="keyword">if</span> (job.target === target) {
          job = f.extend(
            {},
            mill.config.get(<span class="string">'papermill:pandoc_targets:'</span> + target),
            job
          );
        
        }
      
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <ul>
<li>internal option mapping (list of <code>[&#39;old&#39;,&#39;new&#39;]</code> items)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      mill.config.get(<span class="string">'papermill:internal_config_mapping'</span>)
        .forEach(<span class="function"><span class="keyword">function</span> <span class="params">(opt)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>If there is value for &#39;old&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (job[opt[<span class="number">0</span>]]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>set &#39;new&#39; = &#39;old&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            job[opt[<span class="number">1</span>]] = job[opt[<span class="number">0</span>]];</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>delete &#39;old&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">delete</span> job[opt[<span class="number">0</span>]];
          }
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <h2>handle remaining unknown options</h2>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>We need to safe already configured <code>variable</code> string or object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> vario = {};
      <span class="keyword">if</span> (<span class="keyword">typeof</span> job.variable === <span class="string">'string'</span>) {
        vario[job.variable] = <span class="literal">true</span>;
      }      
      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> job.variable === <span class="string">'object'</span>) {
        vario = f.extend({}, vario, job.variable);
      }      
      job.variable = vario;</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p><code>unknownOptions</code> is an array of all the <code>job</code> keys,
  minus the options known by <code>pandoc</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> unknownOptions = f.difference(f.keys(job), pandoc.OPTIONS);</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Now loop over <code>unknownOptions</code> and rewrite them to pandoc-variables </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      unknownOptions.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>(if there is something at all).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (job[v] !== <span class="string">'undefined'</span>) {
          job.variable[v] = job[v] || <span class="literal">true</span>;
          <span class="keyword">delete</span> job[v];          
        }
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>process.exit()</p>

            </div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Finally, we add the <code>job</code> to the list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      config.jobs.push(job);

    });
    
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>callback with result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  callback(<span class="literal">null</span>, config);

}</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <h2>Render</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">(build, callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>require(&#39;eyes&#39;).inspect(build);</p>

            </div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <ul>
<li>make a tmp working directory</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  temp.mkdir(<span class="string">'mill'</span>, <span class="keyword">function</span>(err, workingdir) {

    <span class="keyword">if</span> (err) { <span class="keyword">return</span> callback(err); }</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Debug: don&#39;t use the temp dir</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (mill.config.get(<span class="string">'DEBUG:on'</span>)) {
      workingdir = mill.config.get(<span class="string">'DEBUG:workingdir'</span>) || workingdir;
      fs.mkdirsSync(workingdir);
    }
    
    <span class="keyword">if</span> (mill.DEBUG) { mill.log.debug(<span class="string">"Working directory:"</span>, workingdir); }</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <ul>
<li>build <em>each</em> job</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.each(
      build.jobs,

      <span class="keyword">function</span>(job, callback) {

        <span class="keyword">if</span> (mill.DEBUG) { require(<span class="string">'eyes'</span>).inspect(job); }</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <ul>
<li>copy assetsâ€¦</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> assets = [<span class="string">"template"</span>, <span class="string">"css"</span>];
        async.each(
          assets,
          <span class="keyword">function</span>(asset, callback) {</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>&#39;css&#39; can be an Array, loop it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> asset === <span class="string">'css'</span> &amp;&amp; Array.isArray(job[asset])) {
              async.each(job[asset], <span class="keyword">function</span>(item, callback) {
                <span class="keyword">return</span> copyAsset(item, workingdir, callback);
              });
            } <span class="keyword">else</span> {
              <span class="keyword">return</span> copyAsset(job[asset], workingdir, callback);
            }
          },
          <span class="function"><span class="keyword">function</span> <span class="title">end</span><span class="params">(err)</span> {</span>

            <span class="keyword">if</span> (err) { <span class="keyword">return</span> callback(err); }</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <ul>
<li>handle paths (make &#39;em full!)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> filename = path.basename(job.input)
              .replace(path.extname(job.input), <span class="string">''</span>); <span class="comment">// "/path/foo.bar" &gt; "foo"</span>

            job.input = path.join(build.path, job.input);
            job.output = path.join(workingdir, build.output_dir, job.output, filename);
            <span class="keyword">if</span> (job.bibliography) {
              job.bibliography = path.join(build.path, job.bibliography);
            }
            <span class="keyword">if</span> (job.variable.target === <span class="string">'print'</span>) {
              job.output = job.output + <span class="string">'.pdf'</span>;
            }
            <span class="keyword">if</span> (job.variable.target === <span class="string">'web'</span>) {
              job.output = job.output + <span class="string">'.html'</span>;
            }

            handleInputFiles(job, workingdir, <span class="keyword">function</span>(err, res) {
              <span class="keyword">if</span> (err) { <span class="keyword">return</span> callback(err); }

              handleOutputFiles(job, <span class="keyword">function</span>(err, res) {
                <span class="keyword">if</span> (err) { <span class="keyword">return</span> callback(err); }</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <ul>
<li>finally, build it!</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (mill.DEBUG) { mill.log.debug(<span class="string">'build.job:'</span>, job); }
                pandoc(job, callback);

              });

            });

          }
        );

      }, <span class="function"><span class="keyword">function</span> <span class="title">finishedBuilds</span><span class="params">(err)</span> {</span>

        <span class="keyword">if</span> (err) { <span class="keyword">return</span> callback(err); }

        <span class="keyword">var</span> resultpath = path.join(workingdir, build.output_dir),
          outputpath = path.join(build.path, build.output_dir);

        fs.copy(
        resultpath,
        outputpath,
        callback);

      }
    );

  });

}</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <h1>Helper functions</h1>
<h2>makeWorkingDir TODO: seperate</h2>
<p>function makeWorkingDir(build, callback) {
}</p>
<h2>makeFullPaths TODO: seperate</h2>
<p>function makeFullPaths(build, job, callback) {
}</p>
<h2>copyAssets TODO: seperate</h2>
<p>function copyAssets(build, job, callback) {
}</p>
<h2>handle input files/directories</h2>
<p><code>jandocs</code> interprets directories as a list of files, but we want to combine them!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">handleInputFiles</span><span class="params">(job, workingdir, callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>console.log(job);</p>

            </div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <ul>
<li>basic checking: does anything exist?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fs.exists(job.input, <span class="function"><span class="keyword">function</span> <span class="params">(exists)</span> {</span>
  
    <span class="keyword">if</span> (!exists) {
      <span class="keyword">return</span> callback(<span class="string">"Input does not exists!"</span> + job.input);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>ok, but is it a directory?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fs.stat(job.input, <span class="function"><span class="keyword">function</span> <span class="params">(err, stats)</span> {</span>
      <span class="keyword">if</span> (err) { <span class="keyword">return</span> callback(err); }
      
      <span class="keyword">if</span> (!stats.isDirectory()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>It is NOT a directory, nothing to do!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> callback(<span class="literal">null</span>, job);
      }
      <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>It IS a directory, we need to combine the files in order:</p>
<ul>
<li>prepare the <code>combinedInput</code> and -<code>File</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> combinedInput = <span class="string">''</span>,
            combinedInputFile = path.join(workingdir, path.basename(job.input) + <span class="string">'.md'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <ul>
<li>get list of files</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fs.readdir(job.input, <span class="function"><span class="keyword">function</span> <span class="params">(err, files)</span> {</span>
          
          <span class="keyword">if</span> (err) { <span class="keyword">return</span> callback(err); }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <ul>
<li>read and combine all the files</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          async.each(
            files,
            <span class="function"><span class="keyword">function</span> <span class="title">loop</span><span class="params">(file, callback)</span> {</span>
              fs.readFile(
                path.join(job.input, file),
                { encoding:<span class="string">'utf8'</span> },
                <span class="function"><span class="keyword">function</span> <span class="params">(err, data)</span> {</span>
                  <span class="keyword">if</span> (err) { <span class="keyword">return</span> callback(err); }</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>add file content to <code>combinedInput</code>, with extra empty line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  combinedInput = combinedInput + data + <span class="string">'\n'</span>;
                  callback(<span class="literal">null</span>);
                  
                }
              );
            },
            <span class="function"><span class="keyword">function</span> <span class="title">end</span><span class="params">(err)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>save the <code>combinedInput</code> to file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              fs.writeFile(combinedInputFile, combinedInput, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
                
                <span class="keyword">if</span> (err) { <span class="keyword">return</span> callback(err); }</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>set new input and return job</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                job.input = combinedInputFile;
                callback(err || <span class="literal">null</span>, job);
                
              });
              
            }
          );
        
        });
      
      
      }
      
    });
  
  });
  
}</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <h2>handle output files/directories</h2>
<p>We just need to make shure that all paths where want to write 
 exist in the working directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">handleOutputFiles</span><span class="params">(job, callback)</span> {</span>
  fs.createFile(job.output, callback);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <h2>copyAsset</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">copyAsset</span><span class="params">(asset, workingdir, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> asset === <span class="string">'string'</span>) {
    fs.copy(asset, path.join(workingdir, path.basename(asset)), callback);
  }
  <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>nothing to do</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    callback(<span class="literal">null</span>);
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
